<template>
  <div id="app">
    <Header></Header>
    <Breadcrumb name="ÂÆèÁºñËæëÂô®" slug="macro" root="/app/macroeditor" :feedbackEnable="true">
      <img slot="logo" svg-inline src="../../assets/img/logos/macroeditor.svg" />
      <div class="m-info"></div>
    </Breadcrumb>
    <LeftSidebar :open="false">
      <Nav />
    </LeftSidebar>
    <Main class="m-macroeditor" :withoutRight="true" :withoutLeft="true">
      <h1 class="m-macroeditor-title">
        Êô∫ËÉΩÂÆèÁºñËæëÂô®
        <a
          href="/tool/?pid=265"
          target="_blank"
          class="u-help el-button el-button--success is-plain el-button--mini"
        >
          <i class="el-icon-s-management"></i> ÂÆèËØ≠Ê≥ïÂèÇËÄÉÊâãÂÜå
        </a>
      </h1>
      <div class="m-editor">
        <el-row>
          <el-col :span="12">
            <div class="m-col m-col-left">
              <h2 class="u-subtitle">
                <img class svg-inline src="../../assets/img/macro/cube1.svg" />Âø´Êç∑ÊèíÂÖ•
              </h2>
              <el-form class="u-cmds" ref="form" :model="form" label-width="80px">
                <el-form-item label="ÈáäÊîæÊñπÂºè">
                  <el-radio-group v-model="castType">
                    <el-radio label="cast">ÈáäÊîæ(cast)</el-radio>
                    <el-radio label="fcast">Âº∫Âà∂ÊñΩÊîæ(fcast)</el-radio>
                  </el-radio-group>
                </el-form-item>
                <el-form-item label="ÊäÄËÉΩÂêç">
                  <el-input v-model="skill"></el-input>
                </el-form-item>
                <el-form-item label="Êù°‰ª∂ÈáäÊîæ">
                  <el-switch v-model="isConditional"></el-switch>
                  <template v-if="isConditional && conditions.length > 2">
                    <span class="btn-help">
                      <!-- <el-tooltip
                                        content="ÁÇπÂáªÊü•ÁúãÂÆûÈôÖÈÄªËæëÂÖ≥Á≥ª"
                                        placement="right"
                                        effect="light"
                                        :manual="true"
                                        :value="true"
                                    >
                                        <el-link :underline="false" @click="showRealLogic" style="font-size: 24px;">
                                            üí°ÁÇπÂáªÊü•ÁúãÂÆûÈôÖÈÄªËæëÂÖ≥Á≥ª
                                        </el-link>
                      </el-tooltip>-->
                      <el-button plain icon="el-icon-info" @click="showRealLogic">ÁÇπÂáªÊü•ÁúãÂÆûÈôÖÈÄªËæëÂÖ≥Á≥ª</el-button>
                    </span>
                    <el-alert title="ËØ∑Ê≥®ÊÑèÔºåÊ≠§Â§ÑÈÄâÊã©ÁöÑÈÄªËæëÂ∞Ü‰∏çÂÅöÂ§ÑÁêÜÔºåÁõ¥Êé•ËΩ¨Êç¢‰∏∫ÂÆè‰∏≠ÁöÑ & Âíå | " type="warning"></el-alert>
                    <el-dialog
                      title="ÂÆûÈôÖÈÄªËæë"
                      :visible.sync="logicDialogVisible"
                      :width="Math.min(640,this.windowInnerWidth * 0.9) + 'px'"
                    >
                      <span>{{ logicDialog }}</span>
                      <span slot="footer" class="dialog-footer">
                        <el-button
                          type="primary"
                          @click="logicDialogVisible = false"
                        >Á°Æ ÂÆö</el-button>
                      </span>
                    </el-dialog>
                  </template>
                </el-form-item>
                <template v-if="isConditional">
                  <el-form-item
                    v-for="(condition, index) of conditions"
                    :key="index"
                    :label="`Êù°‰ª∂${index + 1}`"
                  >
                    <template v-if="index >= 1">
                      <el-form-item label>
                        <el-radio-group v-model="condition.logic">
                          <el-radio label="&amp;">Âπ∂‰∏î(and)</el-radio>
                          <el-radio label="|">Êàñ(or)</el-radio>
                        </el-radio-group>
                      </el-form-item>
                    </template>
                    <el-row :gutter="6">
                      <el-col :span="16">
                        <el-select
                          v-model="condition.name"
                          placeholder="Âà§Êñ≠È°πÁõÆ"
                          @change="onConditionChange(index)"
                        >
                          <el-option label="Ëá™Ë∫´ÊúâÂ¢ûÂáèÁõäÊïàÊûú" value="buff"></el-option>
                          <el-option label="Ëá™Ë∫´ÊúâÂ¢ûÂáèÁõäÊïàÊûúÂ±ÇÊï∞" value="buff_level"></el-option>
                          <el-option label="ÁõÆÊ†áÊúâÂ¢ûÂáèÁõäÊïàÊûú" value="tbuff"></el-option>
                          <el-option label="ÁõÆÊ†áÊúâÂ¢ûÂáèÁõäÊïàÊûúÂ±ÇÊï∞" value="tbuff_level"></el-option>
                          <el-option label="Ëá™Ë∫´Â≠òÂú®Â¢ûÂáèÁõäÊïàÊûúÊåÅÁª≠Êó∂Èó¥" value="bufftime"></el-option>
                          <el-option label="ÁõÆÊ†áÂ¢ûÂáèÁõäÊïàÊûúÊåÅÁª≠Êó∂Èó¥" value="tbufftime"></el-option>
                          <el-option label="Ëá™Ë∫´‰∏çÂ≠òÂú®ÊüêÂ¢ûÂáèÁõäÊïàÊûú" value="nobuff"></el-option>
                          <el-option label="ÁõÆÊ†á‰∏çÂ≠òÂú®ÊüêÂ¢ûÂáèÁõäÊïàÊûú" value="tnobuff"></el-option>
                          <el-option label="ÁõÆÊ†áNPCÂº∫Â∫¶Á≠âÁ∫ß" value="npclevel"></el-option>
                          <el-option label="ÁîüÂëΩÂÄºÂíåÊúÄÂ§ßË°ÄÈáèÁöÑÊØîÂÄº" value="life"></el-option>
                          <el-option label="ÂÜÖÂäõÂÄºÂíåÊúÄÂ§ßÂÜÖÂäõÂÄºÁöÑÊØîÂÄº" value="mana"></el-option>
                          <el-option label="ÂâëÊ∞î/Â∞òË∫´ÂàÄÊ∞î/ÊàòÊÑè/ÊÄíÊ∞îÂÄº" value="rage"></el-option>
                          <el-option label="Á∫ØÈò≥Ê∞îÁÇπ/Â∞ëÊûóÁ¶ÖÈÇ£/‰∏ÉÁßÄÂâëËàûÂÄº" value="qidian"></el-option>
                          <el-option label="Á•ûÊú∫/Á´πÈõæÂàÄÊ∞î/Ê†ºÊå°ÂÄº" value="energy"></el-option>
                          <el-option label="Êó•ÁÅµ/ÈáëÂ±èÂàÄÊ∞îÂÄº" value="sun"></el-option>
                          <el-option label="ÊúàÈ≠ÇÂÄº" value="moon"></el-option>
                          <el-option label="Êª°Êó•Áä∂ÊÄÅ" value="sun_power"></el-option>
                          <el-option label="Êª°ÊúàÁä∂ÊÄÅ" value="moon_power"></el-option>
                          <el-option label="ÂÖÖËÉΩÊäÄËÉΩÁöÑÂΩìÂâçÂÖÖËÉΩÂ±ÇÊï∞" value="skill_energy"></el-option>
                          <el-option label="Â≠òÂú®ÊüêÊäÄËÉΩ/Â•áÁ©¥ID" value="skill"></el-option>
                          <el-option label="‰∏çÂ≠òÂú®ÊüêÊäÄËÉΩ/Â•áÁ©¥ID" value="noskill"></el-option>
                          <el-option label="ËØ•ÂÆèÊúÄÂêé‰∏ÄÊ¨°ÈáäÊîæÁöÑÊäÄËÉΩ" value="last_skill"></el-option>
                          <el-option label="Âë®Âõ¥3Â∞∫‰ª•ÂÜÖÊïå‰∫∫Êï∞Èáè" value="nearby_enemy"></el-option>
                          <el-option label="ÊäÄËÉΩË∞ÉÊÅØÂÆåÊàê" value="skill_notin_cd"></el-option>
                        </el-select>
                        <el-row :gutter="2">
                          <el-col
                            :span="10"
                            v-if="needsConditionParams.subname.includes(condition.name)"
                          >
                            <el-input
                              v-model="condition.subname"
                              placeholder="ÂêçÁß∞"
                            ></el-input>
                          </el-col>
                          <el-col
                            :span="7"
                            v-if="needsConditionParams.relation.includes(condition.name)"
                          >
                            <el-select
                              v-model="condition.relation"
                              v-if="!needsConditionParams.relationRestricted.includes(condition.name)"
                            >
                              <el-option label="=" value="="></el-option>
                              <el-option label="Ôºú" value="<"></el-option>
                              <el-option label="Ôºû" value=">"></el-option>
                              <el-option label="‚â•" value=">="></el-option>
                              <el-option label="‚â§" value="<="></el-option>
                              <el-option label="‚â†" value="~="></el-option>
                            </el-select>
                            <el-select
                              v-model="condition.relation"
                              v-else
                            >
                              <el-option label="=" value="="></el-option>
                              <el-option label="‚â†" value="~="></el-option>
                            </el-select>
                          </el-col>
                          <el-col
                            :span="7"
                            v-if="needsConditionParams.value.includes(condition.name)"
                          >
                            <el-input
                              v-model="condition.value"
                              placeholder="ÂÄº"
                            ></el-input>
                          </el-col>
                        </el-row>
                      </el-col>
                      <el-col :span="7">
                        <el-button
                          type="danger"
                          plain
                          circle
                          icon="el-icon-minus"
                          @click="clickMinusCondition(index)"
                          v-if="conditions.length > 1"
                        ></el-button>
                        <el-button
                          type="primary"
                          plain
                          circle
                          icon="el-icon-plus"
                          @click="clickPlusCondition"
                          style="margin-left: 2px;"
                          v-if="index === conditions.length - 1"
                        ></el-button>
                      </el-col>
                    </el-row>
                  </el-form-item>
                </template>
              </el-form>
              <div class="u-submit">
                <el-button type="primary" icon="el-icon-right" class="u-btn" @click="insertLine">ÊèíÂÖ•</el-button>
              </div>
            </div>
          </el-col>
          <el-col :span="12">
            <div class="m-col m-col-right">
              <h2 class="u-subtitle">
                <img class svg-inline src="../../assets/img/macro/cube2.svg" />ÂÆèÁºñËæëÂå∫
              </h2>
              <p class="u-tips">Êåâ‰∏ãTabÈîÆÂç≥ÂèØËá™Âä®ËÅîÊÉ≥Ë°•ÂÖ®</p>
              <codemirror
                v-model="code"
                :options="cmOptions"
                @input="onCmCodeChange"
                ref="cmEditor"
              />
              <div class="u-count">
                <b :class="{ warning: code.length > 128 }">{{ code.length }}</b>
                / 128
                <em>ÔºàËøòÂèØÂÜô {{ 128 - code.length }} Â≠óÔºâ</em>
              </div>
            </div>
          </el-col>
        </el-row>
      </div>
      <Footer />
    </Main>
  </div>
</template>

<script>
import Info from "@/components/Info.vue";
import Nav from "@/components/Nav.vue";
// import Extend from "@/components/Extend.vue";
import { codemirror } from "vue-codemirror";
import CodeMirror from "codemirror";
// import base style
import "codemirror/lib/codemirror.css";
import "codemirror/mode/javascript/javascript.js";
import "codemirror/addon/hint/show-hint.js";
import "codemirror/addon/hint/show-hint.css";
import "codemirror/addon/edit/matchbrackets.js";
import "./z-macro.js";

export default {
  name: "Macro",
  data: function() {
    return {
      windowInnerWidth: window.innerWidth,
      castType: "cast",
      form: null,
      skill: "",
      isConditional: false,
      needsConditionParams: {
        subname: [
          "buff",
          "buff_level",
          "nobuff",
          "bufftime",
          "skill_energy",
          "skill",
          "noskill",
          "skill_notin_cd",
          "tbuff",
          "tbuff_level",
          "tnobuff",
          "tbufftime"
        ],
        relation: [
          "buff_level",
          "tbuff_level",
          "bufftime",
          "life",
          "mana",
          "rage",
          "qidian",
          "energy",
          "sun",
          "moon",
          "skill_energy",
          "last_skill",
          "npclevel",
          "nearby_enemy",
          "tbufftime"
        ],
        value: [
          "buff_level",
          "tbuff_level",
          "bufftime",
          "life",
          "mana",
          "rage",
          "qidian",
          "energy",
          "sun",
          "moon",
          "skill_energy",
          "last_skill",
          "npclevel",
          "nearby_enemy",
          "tbufftime"
        ],
        relationRestricted: ["skill", "noskill", "last_skill"]
      },
      conditions: [
        {
          name: "",
          relation: "=",
          value: "",
          logic: "&",
          subname: ""
        }
      ],
      conditionValueName: {
        buff: "Â≠òÂú®Â¢ûÂáèÁõäÊïàÊûú",
        buff_level: "Â¢ûÂáèÁõäÊïàÊûúÂ±ÇÊï∞",
        nobuff: "‰∏çÂ≠òÂú®ÊüêÂ¢ûÂáèÁõäÊïàÊûú",
        bufftime: "Â¢ûÂáèÁõäÊïàÊûúÊåÅÁª≠Êó∂Èó¥",
        life: "ÁîüÂëΩÂÄºÂíåÊúÄÂ§ßË°ÄÈáèÁöÑÊØîÂÄº",
        mana: "ÂÜÖÂäõÂÄºÂíåÊúÄÂ§ßÂÜÖÂäõÂÄºÁöÑÊØîÂÄº",
        rage: "ÂâëÊ∞î/Â∞òË∫´ÂàÄÊ∞î/ÊàòÊÑè/ÊÄíÊ∞îÂÄº",
        qidian: "Á∫ØÈò≥Ê∞îÁÇπ",
        energy: "Á•ûÊú∫/Á´πÈõæÂàÄÊ∞î/Ê†ºÊå°ÂÄº",
        sun: "Êó•ÁÅµ/ÈáëÂ±èÂàÄÊ∞îÂÄº",
        moon: "ÊúàÈ≠ÇÂÄº",
        sun_power: "Êª°Êó•Áä∂ÊÄÅ",
        moon_power: "Êª°ÊúàÁä∂ÊÄÅ",
        skill_energy: "ÂÖÖËÉΩÊäÄËÉΩÁöÑÂΩìÂâçÂÖÖËÉΩÂ±ÇÊï∞",
        skill: "Â≠òÂú®ÊüêÊäÄËÉΩ/Â•áÁ©¥ID",
        noskill: "‰∏çÂ≠òÂú®ÊüêÊäÄËÉΩ/Â•áÁ©¥ID",
        last_skill: "ËØ•ÂÆèÊúÄÂêé‰∏ÄÊ¨°ÈáäÊîæÁöÑÊäÄËÉΩ",
        npclevel: "ÁõÆÊ†áNPCÂº∫Â∫¶Á≠âÁ∫ß",
        nearby_enemy: "Ëá™Ë∫´Âë®Âõ¥3Â∞∫‰ª•ÂÜÖÊïå‰∫∫Êï∞Èáè",
        skill_notin_cd: "ÊäÄËÉΩË∞ÉÊÅØÂÆåÊàê",
        tbuff: "ÁõÆÊ†áÊúâÂ¢ûÂáèÁõäÊïàÊûú",
        tbuff_level: "ÁõÆÊ†áÊúâÂ¢ûÂáèÁõäÊïàÊûúÂ±ÇÊï∞",
        tnobuff: "ÁõÆÊ†á‰∏çÂ≠òÂú®ÊüêÂ¢ûÂáèÁõäÊïàÊûú",
        tbufftime: "ÁõÆÊ†áÂ¢ûÂáèÁõäÊïàÊûúÊåÅÁª≠Êó∂Èó¥"
      },
      logicDialogVisible: false,
      logicDialog: "",
      region: "",
      cmOptions: {
        tabSize: 4,
        lineNumbers: true,
        line: true,
        styleActiveLine: true,
        lineNumbers: true,
        mode: "text/x-macro",
        extraKeys: { Tab: "autocomplete" },
        matchBrackets: true,
        hintOptions: {
          completeSingle: false
        }
        // more CodeMirror options...
      },
      code: ""
    };
  },
  computed: {
    codemirror() {
      return this.$refs.cmEditor.codemirror;
    }
  },
  methods: {
    clickPlusCondition() {
      this.conditions.push({
        name: "",
        relation: "=",
        value: "",
        logic: "&",
        subname: ""
      });
    },
    clickMinusCondition(index) {
      this.conditions.splice(index, 1);
    },
    onConditionChange(index) {
      let thisName = this.conditions[index].name;
      let thisRelation = this.conditions[index].relation;
      if (
        thisName === "skill" ||
        thisName === "noskill" ||
        thisName === "last_skill"
      ) {
        if (thisRelation !== "=" && thisRelation !== "‚â†") {
          // // ‰øÆÊîπÂà§Êñ≠Á¨¶Âè∑‰∏∫Á≠âÂè∑
          // let tmpArr = this.conditions
          // tmpArr[index].relation = '='
          // this.conditions = tmpArr
          this.conditions[index].relation = "=";
        }
      }
    },
    insertLine() {
      let line = "/" + this.castType + " ";
      if (this.isConditional) {
        let allConditions = "[";
        for (let i = 0; i < this.conditions.length; ++i) {
          let condition = this.conditions[i];
          if (i !== 0) {
            allConditions += condition.logic;
          }
          allConditions += condition.name;
          if (this.needsConditionParams.subname.includes(condition.name)) {
            allConditions = allConditions + ":" + condition.subname;
          }
          if (this.needsConditionParams.relation.includes(condition.name)) {
            allConditions = allConditions + condition.relation;
          }
          if (this.needsConditionParams.value.includes(condition.name)) {
            allConditions = allConditions + condition.value;
          }
        }
        allConditions += "]";
        line = line + allConditions + " ";
      }
      line = line + this.skill + "\n";
      this.code += line.replace(/buff_level/g, "buff");
    },
    onCmCodeChange(value) {
      // this.codemirror.showHint();
    },
    showRealLogic() {
      if (this.conditions <= 2) {
        return false;
      } else {
        let allConditions = "";
        for (let i = 0; i < this.conditions.length; ++i) {
          let condition = this.conditions[i];
          if (i === this.conditions.length - 1) {
            allConditions +=
              // condition.logic === "&" ? " Âπ∂‰∏î " : " Êàñ ";
              condition.logic === "&" ? " & " : " | ";
          } else if (i !== 0) {
            allConditions +=
              // condition.logic === "&" ? " Âπ∂‰∏îÔºà" : " ÊàñÔºà";
              condition.logic === "&" ? " &Ôºà" : " |Ôºà";
          }
          // allConditions += this.conditionValueName[condition.name];
          allConditions += condition.name;
          if (this.needsConditionParams.subname.includes(condition.name)) {
            allConditions = allConditions + ":" + condition.subname;
          }
          if (this.needsConditionParams.relation.includes(condition.name)) {
            allConditions = allConditions + condition.relation;
          }
          if (this.needsConditionParams.value.includes(condition.name)) {
            allConditions = allConditions + condition.value;
          }
        }
        for (
          let parenthesis = 0;
          parenthesis < this.conditions.length - 2;
          ++parenthesis
        ) {
          allConditions += "Ôºâ";
        }
        this.logicDialog = allConditions.replace(/buff_level/g, "buff");
        this.logicDialogVisible = true;
      }
    },
    getUserId() {
      if (User.isLogin()) {
        this.uid = User.getInfo().uid;
      }
    }
  },
  filters: {},
  mounted: function() {
    // this.getUserId();
    // this.prepareMounted();
  },
  components: {
    codemirror,
    Nav
    // Extend
  }
};
</script>

<style lang="less">
@import "../../assets/css/macroeditor.less";
</style>
